<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<style>

</style>

<div id="comfybooks">
   <div class="comfybooks-wrapper">

      <div class="comfybooks-header">
         <div class="comfybooks-header__h2">
            <h2 class="h2only_deck">Це ваша книжкова полиця COMFY!</h2>
            <h2 class="h2only_mob">Вітаємо в бібліотеці COMFY!</h2>
         </div>
         <div class="comfybooks-header__h3">
            <h3>Тут на вас чекатимуть книжки, які ми видали спеціально для наших покупців.<br>Ми поповнюватимемо цю поличку, щоб вам завжди було що почитати <span>&#128521;</span></h3>
         </div>
      </div>

      <div class="comfybooks-content">
         <div class="comfybooks-content__bgrd"></div>
         <div class="comfybooks-content__form">
            <div id="upload-date" class="comfybooks-content__form-wp --upload-date">
               <form id="valid_form" method="post" name="valid_form" class="comfybooks-content__form-wp-flex">
                  <div class="comfybooks-content__form-wp__item --item-textp">
                     <div class="comfybooks-content__form-wp__item-p">
                        <p>В мене є код для отримання книги</p>
                     </div>
                     <div class="open_modal" onclick="OpenModalAlert()">
                        <img src="https://cdn.comfy.ua/media/x/img2/lpbooks/nw_img3_question.svg" alt="">
                        <span class="open_text" id="OpenModalAlert">Код на отримання книжки вказано у вашому чеку за умови виграшу в спеціальній книжковій акції від COMFY.</span>
                     </div>
                  </div>
                  <div class="comfybooks-content__form-wp__item --item-input">
                     <div class="comfybooks-content__form-wp__item-number">
                        <input type="tel" id="item_number" name="name_number" placeholder="Номер телефону" value="" required />
                     </div>
                  </div>
                  <div class="comfybooks-content__form-wp__item --item-input">
                     <div class="comfybooks-content__form-wp__item-key">
                        <input type="text" id="item_key" name="name_key" placeholder="Введіть код сюди" value="" required />
                     </div>
                  </div>
                  <div class="comfybooks-content__form-wp__item --item-submit">
                     <div class="comfybooks-content__form-wp__item-submit">
                        <input type="submit" value="Скачати" name="Submit" />
                     </div>
                  </div>
               </form>
            </div>
            <div id="upload-error" class="comfybooks-content__form-wp --upload-error">
               <div class="comfybooks-content__form-wp-text">
                  <b style="text-align: left; font-size: 16px; line-height: 1;" class="p_only_mob">Помилка</b>
                  <p>Щось пішло не так. Перевірте правильність введених даних</p>
                  <span id="getForm">Спробувати ще раз</span>
               </div>
            </div>
            <div id="upload-done" class="comfybooks-content__form-wp --upload-done">
               <div class="comfybooks-content__form-wp-text">
                  <p>Ваш код успішно опрацьовано! Насолоджуйтесь книгами від Comfy</p>
                  <div>Зверніть увагу, посилання на завантаження книжок буде активним лише протягом <span>15 хвилин.</span></div>
               </div>
            </div>
         </div>
         <div id="content-books" class="content-books">
            <div class="content-books__wrap"></div>
         </div>
      </div>

   </div>

   <div class="comfybooks-content-text">
      <div class="comfybooks-content-text__wrap">
         <div class="comfybooks-content-text__subtitle">
            COMFY — не лише про гаджети. А й про домашній затишок та щасливі родини.
         </div>
         <div class="comfybooks-content-text__grid">
            <div class="comfybooks-content-text__item">
               <div class="comfybooks-content-text__txt">
                  Відтепер COMFY — ще й джерело якісної української літератури. Ми хочемо, щоб кількість читачів українською зростала, тому запускаємо власну електронну бібліотеку.
               </div>
               <div class="comfybooks-content-text__img">
                  <img src="https://cdn.comfy.ua/media/x/img2/lpbooks/lpbooks_item1.svg" alt="">
               </div>
            </div>
            <div class="comfybooks-content-text__item">
               <div class="comfybooks-content-text__txt">
                  Відтепер у COMFY є книжки для дорослих та дітей! Скористайтеся додатковими можливостями для розвитку та читайте українською.
               </div>
               <div class="comfybooks-content-text__img --imgbtn">
                  <div class="comfybooks-content-text__btn"><span>Дорослі</span></div>
                  <div class="comfybooks-content-text__btn"><span>Діти</span></div>
               </div>
            </div>
            <div class="comfybooks-content-text__item">
               <div class="comfybooks-content-text__txt">
                  Кращі кулінарні рецепти та побутові поради, дитячі вірші та оповідання тепер завжди можуть бути у вашому телефоні або в електронній книжці.
               </div>
               <div class="comfybooks-content-text__img">
                  <img src="https://cdn.comfy.ua/media/x/img2/lpbooks/lpbooks_item2.svg" alt="">
               </div>
            </div>
         </div>
      </div>
   </div>

</div>

<div class="wrap-modalbox"></div>
<div class="overlay hidden"></div>

<script>
   function OpenModalAlert() {
      var OpenModalAlert = document.getElementById("OpenModalAlert");
      OpenModalAlert.classList.toggle("OpenModalShow");
   }
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.js"></script>

<script>
   $(document).ready(function () {
      $("fieldset input").click(function () {
         $("fieldset label.error").remove()
      });

      $("#valid_form").validate({
         rules: {
            name_key: {
               required: true
            },
            name_number: {
               required: true,
               number: true
            }
         },
         messages: {
            name_key: {
               required: "*Обов'язкове поле"
            },
            name_number: {
               required: "*Обов'язкове поле",
               number: "Введіть номер телефону"
            }
         },
         errorPlacement: function (error, element) {
            if (element.attr("name") == "name_number") error.insertAfter($("input[name=name_number]"));
            if (element.attr("name") == "name_key") error.insertAfter($("input[name=name_key]"));
         },
         submitHandler: function (form) {

            let getNumber = document.getElementById('item_number').value;
            let getKey = document.getElementById('item_key').value;
            let valid_form = document.getElementById("upload-date");
            let upload_error = document.getElementById("upload-error");
            let upload_done = document.getElementById("upload-done");
            let content_books = document.getElementById("content-books");
            let __getNumber = getNumber;
            let __getKey = getKey.trim();
            let requestURL = `https://tst.comfy.ua/api/customers/books/${__getNumber}/activate?key=${__getKey}`;

            function sendRequest(method, url) {
               const headers = {
                  'Content-Type': 'application/json'
               }

               return fetch(url, {
                  method: method,
                  headers: headers
               })
                  .then(response => {
                     if (response.ok) {
                        valid_form.classList.remove("active_block");
                        upload_error.classList.remove("not-active_block");
                        upload_done.classList.remove("not-active_block");

                        valid_form.classList.add("not-active_block");
                        upload_error.classList.add("not-active_block");
                        upload_done.classList.add("active_block");
                        content_books.classList.add("active_block");
                        return response.json();
                     }

                     return response.json().then(error => {
                        console.log(error);
                        console.log(response.status);

                        valid_form.classList.remove("active_block");
                        upload_error.classList.remove("not-active_block");
                        upload_done.classList.remove("not-active_block");

                        valid_form.classList.add("not-active_block");
                        upload_error.classList.add("active_block");
                        upload_done.classList.add("not-active_block");

                        document.getElementById("getForm").onclick = function (e) {
                           document.getElementById("item_number").value = "";
                           document.getElementById("item_key").value = "";
                           valid_form.classList.remove("not-active_block");
                           upload_error.classList.remove("active_block");
                           upload_done.classList.remove("not-active_block");

                           valid_form.classList.add("active_block");
                           upload_error.classList.add("not-active_block");
                           upload_done.classList.add("not-active_block");
                        }

                     })
                  })
            }

            sendRequest('GET', requestURL)
               .then(data => {
                  console.log(data);
                  let mass = data.books;

                  // modalBox
                  document.querySelector('.wrap-modalbox').innerHTML = `<div class="wrap-modalbox__wrap"></div>`;
                  for (let key in mass) {
                     let mass_length = data.books.length;
                     let mass_img_length = mass[key].images.length;

                     async function getModalBox() {
                        await getModalBoxHtml();
                        await getModalBoximg();
                        await getModalSwiper();
                     }
                     getModalBox();

                     function getModalBoxHtml() {
                        let row = document.createElement('div')
                        row.classList.add(`wrap-modalbox__item${key}`);
                        row.innerHTML = `
                           <div id="popup" class="modal modal-item-${key} hidden">
                              <div class="modal__wrap">
                                 <button class="btn-close"><img src="https://cdn.comfy.ua/media/x/img2/close_popup_new.svg" alt=""></button>

                                 <div class="swiper-container gallery-top-${key}">

                                    <div class="swiper-wrapper-${key} swiper-wrapper">
            
                                    </div>
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination pagination_bullet"></div>
                                    <div class="swiper-pagination pagination_progress"></div>
                                 </div>
                              </div>
                           </div>
                           `
                        document.querySelector('.wrap-modalbox__wrap').appendChild(row)
                     }
                     function getModalBoximg() {
                        for (let i = 0; i < mass_img_length; i++) {
                           let row2 = document.createElement('div');
                           row2.classList.add("swiper-slide");
                           row2.innerHTML = `
                                 <div class="swiper-slide-img">
                                    <img src="https://cdn.comfy.ua/${mass[key].images[i]}" alt="">
                                 </div>
                              `
                           if (mass_img_length === 1) {
                              row2.classList.add("swiper-slide", "defult_cursor");
                           }
                           document.querySelector(`.swiper-wrapper-${key}`).appendChild(row2)
                        }
                     }

                     function getModalSwiper() {
                        var swiper = new Swiper(`.gallery-top-${key}`, {
                           slidesPerView: 1,
                           spaceBetween: 0,
                           loop: false,
                           grabCursor: true,
                           pagination: {
                              el: `.pagination_bullet`,
                              clickable: true,
                              renderBullet: function (index, className) {
                                 return '<span class="' + className + '">' + (index + 1) + "</span>";
                              },
                           },
                           navigation: {
                              nextEl: ".swiper-button-next",
                              prevEl: ".swiper-button-prev",
                           },
                        });
                        var pagingSwiper = new Swiper(`.gallery-top-${key}`, {
                           pagination: {
                              el: ".pagination_progress",
                              type: "fraction",
                           },
                        });
                        swiper.controller.control = pagingSwiper;
                     }
                  }

                  // ContentBooks
                  document.querySelector('.content-books').innerHTML = `<div class="content-books__wrap"></div>`
                  for (let key in mass) {
                     let mass_books_length = mass[key].files.length;
                     function gettst() {
                        gettst1();
                        gettst2();
                     }
                     gettst();

                     function gettst1() {
                        let row = document.createElement('div')
                        row.classList.add('content-books__item-grid');
                        row.innerHTML = `
                        <div class="content-books__item-left">
                           <div class="content-books__item-left-slider">
                              <button class="btn-open btn-open-item-${key}"><img src="https://cdn.comfy.ua/${mass[key].images[0]}" alt=""></button>
                           </div>
                        </div>
                        <div class="content-books__item-right">
                           <div class="content-books__item-right-row">
                              <div class="content-books__item-right-title">${key + " " + mass[key].title}</div>
                              <div class="content-books__item-right-language">${key + " " + mass[key].language}, ${key + " " + mass[key].year}</div>
                              <div class="content-books__item-right-description">${key + " " + mass[key].description}</div>
                           </div>
                           <div class="content-books__item-right-row">
                              <div class="content-books__item-right-books-${key}">
                                 
                                 <div class="content-books__grid content-books__item-right-books-item-${key}">

                                 </div>
                              </div>
                           </div>
                        </div>
                        `
                        document.querySelector('.content-books__wrap').appendChild(row)
                     }

                     function gettst2() {
                        for (let i = 0; i < mass_books_length; i++) {
                           let row3 = document.createElement('div');
                           row3.classList.add("content-books__items");
                           if (i == 0) {
                              let row3 = document.createElement('div');
                              row3.classList.add("content-books__items");
                              row3.innerHTML = `
                              <div class="content-books__items-format">
                                 <input class="input__item-${key}" type="radio" id="${mass[key].files[i].format}-${key}" name="radiogp-${key}" value="https://comfy.ua/${mass[key].files[i].url}" checked>
                                 <label for="${mass[key].files[i].format}-${key}">${mass[key].files[i].format}</label>
                              </div>
                              `
                              document.querySelector(`.content-books__item-right-books-item-${key}`).append(row3)

                              let row4 = document.createElement('div');
                              row4.classList.add(`content-books__items-wrap-btn-${key}`);
                              row4.innerHTML = `
                                 <button class="download-btn-${key} submit">Завантажити</button>
                              `
                              document.querySelector(`.content-books__item-right-books-${key}`).appendChild(row4)

                           } else {
                              row3.innerHTML = `
                              <div class="content-books__items-format">
                                 <input class="input__item-${key}" type="radio" id="${mass[key].files[i].format}-${key}" name="radiogp-${key}" value="https://comfy.ua/${mass[key].files[i].url}">
                                 <label for="${mass[key].files[i].format}-${key}">${mass[key].files[i].format}</label>
                              </div>
                              `
                              document.querySelector(`.content-books__item-right-books-item-${key}`).append(row3)
                           }
                        }
                     }

                     const openFileBtn = document.querySelectorAll(`.download-btn-${key}`);
                     openFileBtn.forEach(function (e, i) {
                        e.addEventListener('click', function () {
                           var selected = document.querySelector(`input[name=radiogp-${key}]:checked`);
                           open(selected.value);
                        })
                     })

                     $(`input[name=radiogp-${key}]`).on("click", function (e) {
                        e.preventDefault();
                        setTimeout(() => {
                           let downloadBtns = document.querySelectorAll(`.download-btn-${key}`)
                           $(this).prop("checked", !this.checked).trigger("change");
                           console.log($(this).prop("checked") + ` ${key}`);
                           if ($(this).prop("checked") == true) {
                              $(`.download-btn-${key}`).addClass('submit-active');
                              $(`.download-btn-${key}`).removeClass('submit-not-active');
                           } else if ($(this).prop("checked") == false) {
                              $(`.download-btn-${key}`).removeClass('submit-active');
                              $(`.download-btn-${key}`).addClass('submit-not-active');
                           }
                        });
                     });

                  }

                  const modal = document.querySelectorAll(".modal");
                  const overlay = document.querySelector(".overlay");
                  const openModalBtn = document.querySelectorAll(".btn-open");
                  const closeModalBtn = document.querySelectorAll(".btn-close");


                  overlay.addEventListener("click", function () {
                     openModalBtn.forEach(function (e, i) {
                        modal[i].classList.add("hidden");
                        overlay.classList.add("hidden");

                     })
                  });

                  openModalBtn.forEach(function (e, i) {
                     e.addEventListener('click', function () {
                        modal[i].classList.remove("hidden");
                        overlay.classList.remove("hidden");

                     })
                     closeModalBtn[i].addEventListener('click', function () {
                        modal[i].classList.add("hidden");
                        overlay.classList.add("hidden");

                     })
                  })

                  // window.addEventListener('scroll', () => {
                  //    document.documentElement.style.setProperty('--scroll-y', `${window.scrollY}px`);
                  // });

               })
               .catch(err => console.log(err))

         }
      });
      $(function () {
         $("#item_number").mask("380999999999");
      });

   });

</script>